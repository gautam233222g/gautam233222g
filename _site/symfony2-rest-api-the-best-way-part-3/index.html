
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>part 3 - Symfony2 API: the rest of REST</title>
    
    <meta name="description" content="REST API tutorial on symfony2 with best practices">
    
    <meta name="author" content="Giulio De Donato">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="/assets/themes/readable-liuggio/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/readable-liuggio/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/readable-liuggio/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/readable-liuggio/js/styles/github.css" rel="stylesheet">
    <link href="/assets/themes/readable-liuggio/js/uitotop-jquery-plugin.css" rel="stylesheet">
    <!-- Google Web Font-->
    <link href='http://fonts.googleapis.com/css?family=Lato:400,400italic,900italic,300' rel='stylesheet' type='text/css'>
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="" href="http://welcometothebundle.com/feed.xml">

    <link rel="shortcut icon" href="/assets/themes/readable-liuggio/img/icon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />

</head>
<body>
<div class="container">
    <header>
        <div id="header">
            <div class="logo span6"><img src="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg"></div>
            <h2><a title="Blog of Giulio De Donato" id="sitename" href="http://www.welcometothebundle.com/">Welcome to the bundle</a></h2>  
            
            <p>Best Practices, Symfony2, developing, and blah blah blah.</p>
            
        </div>
    </header>

<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
    <section id="content">
        <div class="row">
            <aside class="span3">
                <div class="well boxed profile">
                    <p align="center"><img
                            src="http://www.gravatar.com/avatar/662a52953053d94a145a00df9da9f0d2.png?size=48" class="img-rounded">
                    </p>
                    <p style="font-size:95%">I'm liuggio 
                    (aka <a href="https://plus.google.com/115690008178168800202?rel=author" rel="author" title="Giulio De Donato">Giulio De Donato</a>)
                         tons of lines of code ago I took a degree in Computer Science, I'm the
                        lead developer at Terravision. I can't stop studying, you could find me in some conferences, I'm a proud member of <a href="http://roma.grusp.org/">PHP user group</a>, 
                        and right now I'm in <a href="https://maps.google.it/maps?q=vatican+city&hnear=Vatican+City&gl=it&t=h&z=16">the center of Rome</a>.</p>
                        <p><strong>ps: I love open-source.</strong></p>
                </div>
                <!-- start sticky section
#################################################
                -->
                <div class="well social boxed">
                    <div class="center" align="center">
                        <a href="https://github.com/liuggio" title="Giulio De Donato github projects"
                           target="_blank"><img src="/assets/themes/readable-liuggio/img/github.png" width="32"></a>
                        <a href="http://twitter.com/liuggio" title="Giulio De Donato twitter page"
                           target="_blank"><i class="icon-twitter"></i></a>
                        <a href="http://www.linkedin.com/profile/view?id=94597934"
                           title="Giulio De Donato Linkedin profile" target="_blank">
                           <i class="icon-linkedin"></i></a>
                        <a href="http://www.slideshare.net/liuggio"
                           title="Giulio De Donato slideshare presentations" target="_blank">
                           <img src="/assets/themes/readable-liuggio/img/slide.png" width="32">
                           </a>
                    </div>
                    <div class="center">
                        <div align="center" class="twitter-cnt">
                            <a href="https://twitter.com/liuggio" class="twitter-follow-button"
                               data-show-count="false" data-size="large" data-dnt="true" title="Follow Giulio De Donato">Follow
                                @liuggio</a>
                            <script>!function (d, s, id) {
                                var js, fjs = d.getElementsByTagName(s)[0];
                                if (!d.getElementById(id)) {
                                    js = d.createElement(s);
                                    js.id = id;
                                    js.src = "//platform.twitter.com/widgets.js";
                                    fjs.parentNode.insertBefore(js, fjs);
                                }
                            }(document, "script", "twitter-wjs");</script>
                        </div>
                    </div>
                </div>

                <!-- end sticky section
                ================================================== -->
                <div class="boxed categories">
                    
                    <ul class="nav nav-tabs nav-stacked">
                        
                        


  
     
    	<li><a href="/categories.html#post-ref">
    		post
    	</a></li>
     
    	<li><a href="/categories.html#tutorial-ref">
    		tutorial
    	</a></li>
     
    	<li><a href="/categories.html#talk-ref">
    		talk
    	</a></li>
     
    	<li><a href="/categories.html#blah-blah-blah-ref">
    		blah-blah-blah
    	</a></li>
    
  


                    </ul>
                </div>
                
                <div class="boxed cloud">
                    <h3>Tags</h3>
                    <ul class="tag_box">
                        
                        


  
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#assetic-ref" rel="2">assetic <span>2</span></a></li>
     
    	<li class="tag-list tag-size-11"><a href="/tags.html#symfony2-ref" rel="11">symfony2 <span>11</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#bundle-ref" rel="3">bundle <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#github-ref" rel="1">github <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#bitbucket-ref" rel="1">bitbucket <span>1</span></a></li>
     
    	<li class="tag-list tag-size-13"><a href="/tags.html#PHP-ref" rel="13">PHP <span>13</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#assets-ref" rel="3">assets <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#rackspace-ref" rel="1">rackspace <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#CDN-ref" rel="1">CDN <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#monitoring-ref" rel="1">monitoring <span>1</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#statsd-ref" rel="3">statsd <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#vagrant-ref" rel="1">vagrant <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#graphite-ref" rel="1">graphite <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#tvision-ref" rel="1">tvision <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#team-ref" rel="1">team <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#coding-ref" rel="1">coding <span>1</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#conference-ref" rel="2">conference <span>2</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#cache-ref" rel="3">cache <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#optimization-ref" rel="1">optimization <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#servergrove-ref" rel="1">servergrove <span>1</span></a></li>
     
    	<li class="tag-list tag-size-4"><a href="/tags.html#phpunit-ref" rel="4">phpunit <span>4</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#guard-ref" rel="1">guard <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#automate-ref" rel="1">automate <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#code-inspection-ref" rel="1">code-inspection <span>1</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#TDD-ref" rel="2">TDD <span>2</span></a></li>
     
    	<li class="tag-list tag-size-4"><a href="/tags.html#BDD-ref" rel="4">BDD <span>4</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#test-ref" rel="3">test <span>3</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#phpspec-ref" rel="2">phpspec <span>2</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#HTTP-ref" rel="1">HTTP <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#APC-ref" rel="1">APC <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#redis-ref" rel="1">redis <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#doctrine2-ref" rel="1">doctrine2 <span>1</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#doctrine-ref" rel="2">doctrine <span>2</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#php-internal-ref" rel="1">php-internal <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#interface-ref" rel="1">interface <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#design-patterns-ref" rel="1">design-patterns <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#talk-ref" rel="1">talk <span>1</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#rest-ref" rel="3">rest <span>3</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#api-ref" rel="3">api <span>3</span></a></li>
     
    	<li class="tag-list tag-size-4"><a href="/tags.html#DDD-ref" rel="4">DDD <span>4</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#value objects-ref" rel="2">value objects <span>2</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#money-ref" rel="2">money <span>2</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#symfony-ref" rel="1">symfony <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#price-ref" rel="1">price <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#fixture-ref" rel="1">fixture <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#functional-ref" rel="1">functional <span>1</span></a></li>
    
  



                    </ul>
                </div>

                
                    <div id="related" class="boxed">
                    <h3>Related Posts</h3>
                    <ul class="posts">
                    
                    <li>
                      <a href="/speedup-symfony-functional-tests-phpunit">Speed up PHPUnit and functional tests with Symfony and fastest</a>
                    </li>
                    
                    <li>
                      <a href="/price-more-then-money-php-library">Price: more then Money - PHP library</a>
                    </li>
                    
                    <li>
                      <a href="/best-resources-about-symfony-tdd-bdd-ddd-methologies">(my) Best resources about methodologies on Symfony, PHP, DDD, BDD ...</a>
                    </li>
                    
                    <li>
                      <a href="/domain-driven-design-and-symfony-for-simple-app">Domain Driven Design principles with Symfony2 also for dummy applications</a>
                    </li>
                    
                    <li>
                      <a href="/persist-the-money-doctrine-value-object">Persist the Money, Doctrine Value Object</a>
                    </li>
                    
                    </ul>
                    </div>
                
            </aside>

            <!-- start content section
            ================================================== -->
            <div class="span9">
                

<div class="span9">
    <div class="page-header">
        <div class="row">
            <h1 class="span8">part 3 - Symfony2 API: the rest of REST 
            </h1>
          <div class="span1 right bottom sticky center">
              
              <div id="edit-github">
                  <a class="btn btn-mini" target="_blank" href="https://github.com/liuggio/liuggio.github.com/edit/master/_posts/2013-11-20-symfony2-rest-api-the-best-way-part-3.md" title="Found a typo? Please edit it on Github"><i class="icon-edit pull-left"></i><b>Fix</b></a>
              </div>
              

              <div id="sticky-pagination" class="hidden">
                  
                      <a class="btn-mini pull-left" target="_blank" href="/web-api-rest-with-symfony2-the-best-way-the-post-method" title="part2 - Web API REST with Symfony2">
                          <i class="icon-arrow-left"></i>
                      </a>
                  

                  
                  <a class="btn-mini pull-right" target="_blank" href="/persist-the-money-doctrine-value-object" title="Persist the Money, Doctrine Value Object">
                      <i class="icon-arrow-right"></i>
                  </a>
                  
              </div>

               <a href="https://twitter.com/share" class="twitter-share-button" data-via="liuggio" data-size="large"
                  data-count="none">Tweet</a>
               <script>!function (d, s, id) {
                   var js, fjs = d.getElementsByTagName(s)[0];
                   if (!d.getElementById(id)) {
                       js = d.createElement(s);
                       js.id = id;
                       js.src = "//platform.twitter.com/widgets.js";
                       fjs.parentNode.insertBefore(js, fjs);
                   }
               }(document, "script", "twitter-wjs");</script>
           </div>
        </div>
        <hr>
        <div class="row">
            <div class="span4">
                <div class="date"><span>03 December 2013</span></div>
            </div>

            <div class="span5">
                
                <ul class="tag_box">
                    
                    


  
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#rest-ref">rest <span>3</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#api-ref">api <span>3</span></a></li>
     
    	<li class="tag-list tag-size-11"><a href="/tags.html#symfony2-ref">symfony2 <span>11</span></a></li>
    
  



                </ul>
                
            </div>
        </div>
    </div>
    <article>
        
<h3 id="part-3---the-rest-of-rest">Part 3 - the rest of rest.</h3>

<p>This is trilogy&#8217;s final, in the part1 &#8216;<a href="http://welcometothebundle.com/symfony2-rest-api-the-best-2013-way/">best web API with Symfony2</a>&#8217; we created the application and the bundle, we wrote the <code>GET</code> method, we also talked about the importance of the Interfaces, the content negotiation, and we gave an example of dumb controllers and smart services&#8230;</p>

<p>In the part2 &#8216;<a href="http://welcometothebundle.com/symfony2-rest-api-the-best-2013-way/">REST and Symfony the best way</a>&#8217; we created a new <code>Page</code> via <strong>REST API</strong>, we talked about <code>idempotent</code> and <code>safe</code> methods, and we understood how much the form is important&#8230;</p>

<p>In this article we are going to show how to properly modify a given resource using <code>PUT</code>,<code>PATCH</code>, how to handle different role for the Page resource, and how to disable the CRSF protection only when using API.</p>

<h2 id="the-github-repository">The github repository</h2>

<p>There&#8217;s a repository at <a href="https://github.com/liuggio/symfony2-rest-api-the-best-2013-way/">liuggio/symfony2-rest-api-the-best-2013-way</a>
you could see the working code using the tag <code>part3</code> with</p>

<pre><code>php composer.phar create-project liuggio/symfony2-rest-api-the-best-2013-way blog-rest-symfony2 -sdev
cd blog-rest-symfony2
git checkout -f part3
bin/phpunit -c app
</code></pre>

<p>All the tags for the demo project are at <a href="https://github.com/liuggio/symfony2-rest-api-the-best-2013-way/tags">tags</a>, and also you could compare the 2 articles with <a href="https://github.com/liuggio/symfony2-rest-api-the-best-2013-way/compare/part2...part3">compare/part2&#8230;part3</a>.</p>

<h2 id="this-is-a-crud-world">This is a CRUD world</h2>

<p>In the second article, we also saw how to properly use the HTTP-verbs, if you have to create a resource you should use the <code>POST</code> method,
 if you want to fetch a resource you should use the <code>GET</code> method,
 you have all the tools in order to create a CRUD (Create, Read, Update and Delete) with REST.</p>

<blockquote>
The key principles of REST involve separating your API into logical resources. These resources are manipulated using HTTP requests where the method (GET, POST, PUT, PATCH, DELETE) has specific meaning.<small>Best Practices for Designing a Pragmatic RESTful API</small>
</blockquote>

<blockquote>
The great thing about REST is that you're leveraging existing HTTP methods to implement significant functionality on just a single /tickets endpoint. There are no method naming conventions to follow and the URL structure is clean and clear.<small>Best Practices for Designing a Pragmatic RESTful API</small>
</blockquote>

<h2 id="the-update-implementation">The update implementation</h2>

<p><code>PUT</code> method is used to replace all the content of a resource,
the <code>PATCH</code> method is utilized instead to partially update a resource.</p>

<h3 id="put-that-patch">PUT that PATCH</h3>

<p>As always we need the stories and the tests before coding:</p>

<ul>
  <li>
    <p><strong>PUT</strong> - given a Page, is possible to replace all its proprieties, and if that page doesn&#8217;t exist should be created.</p>
  </li>
  <li>
    <p><strong>PATCH</strong> - given a Page, is possible to replace some proprieties.</p>
  </li>
</ul>

<h3 id="githubs-star">github&#8217;s star</h3>

<p>If you where github, how did you develop the API in order to add a star to a Gist?</p>

<p>Story: A user should be able to &#8216;star&#8217; a gist.</p>

<p>Github api/v3 uses:</p>

<ul>
  <li>PUT    /gists/:id/star - to &#8216;star&#8217; a gist and it will response a <code>204 No Content</code></li>
  <li>DELETE /gists/:id/star - to &#8216;unstar&#8217; a gist and it will response a <code>204 No Content</code></li>
  <li>GET    /gists/:id/star - to check if a gist is starred was starred will response a <code>204 No Content</code> and return a <code>404</code> if it wasn&#8217;t.</li>
</ul>

<h3 id="put-the-implementation">PUT the implementation</h3>

<p>The implementation of the PUT and PATCH methods should be in our service called <code>PageHandler</code>, all the job is already done by the <code>processForm</code> function that we have developed in the last article.</p>

<p>Adding to <code>PageHandlerInterface</code> the new methods, the <code>PageHandler</code> will be:</p>

<pre><code>/**
 * Edit a Page, or create if not exist.
 *
 * @param PageInterface $page
 * @param array         $parameters
 *
 * @return PageInterface
 */
public function put(PageInterface $page, array $parameters)
{
    return $this-&gt;processForm($page, $parameters, 'PUT');
}

/**
 * Partially update a Page.
 *
 * @param PageInterface $page
 * @param array         $parameters
 *
 * @return PageInterface
 */
public function patch(PageInterface $page, array $parameters)
{
    return $this-&gt;processForm($page, $parameters, 'PATCH');
}
</code></pre>

<p>The function Put doesn&#8217;t create the resource.</p>

<h4 id="so--easy">So #@* easy?</h4>

<p><strong>yes!</strong></p>

<p>The functions need a Page object and its parameters, the form will do the magic.</p>

<h3 id="the-controller">The Controller</h3>

<p>In the controller we have to handle the HTTP status code, the headers, and the page object.</p>

<p>The tests for putAction are two, one for the creation, and one for the modification:</p>

<pre><code>public function testJsonPutPageActionShouldModify()
{
    $fixtures = array('Acme\BlogBundle\Tests\Fixtures\Entity\LoadPageData');
    $this-&gt;customSetUp($fixtures);
    $pages = LoadPageData::$pages;
    $page = array_pop($pages);

    $this-&gt;client-&gt;request('GET', sprintf('/api/v1/pages/%d.json', $page-&gt;getId()), array('ACCEPT' =&gt; 'application/json'));
    $this-&gt;assertEquals(200, $this-&gt;client-&gt;getResponse()-&gt;getStatusCode(), $this-&gt;client-&gt;getResponse()-&gt;getContent());

    $this-&gt;client-&gt;request(
        'PUT',
        sprintf('/api/v1/pages/%d.json', $page-&gt;getId()),
        array(),
        array(),
        array('CONTENT_TYPE' =&gt; 'application/json'),
        '{"title":"abc","body":"def"}'
    );

    $this-&gt;assertJsonResponse($this-&gt;client-&gt;getResponse(), 204, false);
    $this-&gt;assertTrue(
        $this-&gt;client-&gt;getResponse()-&gt;headers-&gt;contains(
            'Location',
            sprintf('http://localhost/api/v1/pages/%d.json', $page-&gt;getId())
        ),
        $this-&gt;client-&gt;getResponse()-&gt;headers
    );
}

public function testJsonPutPageActionShouldCreate()
{
    $id = 0;
    $this-&gt;client-&gt;request('GET', sprintf('/api/v1/pages/%d.json', $id), array('ACCEPT' =&gt; 'application/json'));
    $this-&gt;assertEquals(404, $this-&gt;client-&gt;getResponse()-&gt;getStatusCode(), $this-&gt;client-&gt;getResponse()-&gt;getContent());

    $this-&gt;client-&gt;request(
        'PUT',
        sprintf('/api/v1/pages/%d.json', $id),
        array(),
        array(),
        array('CONTENT_TYPE' =&gt; 'application/json'),
        '{"title":"abc","body":"def"}'
    );

    $this-&gt;assertJsonResponse($this-&gt;client-&gt;getResponse(), 201, false);
}
</code></pre>

<p>And the <code>PUT</code> controller will look like:</p>

<pre><code>/**
 * Update existing page from the submitted data or create a new page at a specific location.
 *
 * @ApiDoc(
 *   resource = true,
 *   input = "Acme\DemoBundle\Form\PageType",
 *   statusCodes = {
 *     201 = "Returned when the Page is created",
 *     204 = "Returned when successful",
 *     400 = "Returned when the form has errors"
 *   }
 * )
 *
 * @Annotations\View(
 *  template = "AcmeBlogBundle:Page:editPage.html.twig",
 *  templateVar = "form"
 * )
 *
 * @param Request $request the request object
 * @param int     $id      the page id
 *
 * @return FormTypeInterface|View
 *
 * @throws NotFoundHttpException when page not exist
 */
public function putPageAction(Request $request, $id)
{
    try {
        if (!($page = $this-&gt;container-&gt;get('acme_blog.page.handler')-&gt;get($id))) {
            $statusCode = Codes::HTTP_CREATED;
            $page = $this-&gt;container-&gt;get('acme_blog.page.handler')-&gt;post(
                $request-&gt;request-&gt;all()
            );
        } else {
            $statusCode = Codes::HTTP_NO_CONTENT;
            $page = $this-&gt;container-&gt;get('acme_blog.page.handler')-&gt;put(
                $page,
                $request-&gt;request-&gt;all()
            );
        }

        $routeOptions = array(
            'id' =&gt; $page-&gt;getId(),
            '_format' =&gt; $request-&gt;get('_format')
        );

        return $this-&gt;routeRedirectView('api_1_get_page', $routeOptions, $statusCode);

    } catch (InvalidFormException $exception) {

        return $exception-&gt;getForm();
    }
}
</code></pre>

<p>The PatchPageAction and the DeletePageAction will be very similar.</p>

<h3 id="manually-testing-the-lifecycle">Manually testing the lifecycle</h3>

<p>We are going to reproduce all the page lifecycle putting the value of the result of the post
into a bash variable, so we could reuse. </p>

<pre><code>location=`curl -X POST -d '{"title":"liuggio","body":"homepage"}' \
   http://localhost:8000/api/v1/pages.json \
   --header "Content-Type:application/json" -v 2&gt;&amp;1 | grep Location | cut -d \  -f 3`;

echo "created result at: "$location
</code></pre>

<p>the result will look something like:</p>

<pre><code>created result at http://localhost:8000/api/v1/pages/143.json
</code></pre>

<p>and we are going to use this $location variable and we will modify the resource:</p>

<pre><code>curl -X PUT -d '{"title":"my","body":"homepage"}' $location --header "Content-Type:application/json" -v

curl -X PATCH -d '{"body":"life"}' $location --header "Content-Type:application/json" -v
</code></pre>

<p>and then the get:</p>

<pre><code>curl $location --header "Content-Type:application/json" 
</code></pre>

<p>the result will be:</p>

<pre><code>{"id":140,"title":"my","body":"life"}
</code></pre>

<h2 id="get-all-the-pages">GET all the Pages</h2>

<p>We want to be able to get a list of all the pages, we want to limit the result with pagination.</p>

<pre><code>/**
 * List all pages.
 *
 * @ApiDoc(
 *   resource = true,
 *   statusCodes = {
 *     200 = "Returned when successful"
 *   }
 * )
 *
 * @Annotations\QueryParam(name="offset", requirements="\d+", nullable=true, description="Offset from which to start listing pages.")
 * @Annotations\QueryParam(name="limit", requirements="\d+", default="5", description="How many pages to return.")
 *
 * @Annotations\View(
 *  templateVar="pages"
 * )
 *
 * @param Request               $request      the request object
 * @param ParamFetcherInterface $paramFetcher param fetcher service
 *
 * @return array
 */
public function getPagesAction(Request $request, ParamFetcherInterface $paramFetcher)
{
    $offset = $paramFetcher-&gt;get('offset');
    $offset = null == $offset ? 0 : $offset;
    $limit = $paramFetcher-&gt;get('limit');

    return $this-&gt;container-&gt;get('acme_blog.page.handler')-&gt;all($limit, $offset);
}
</code></pre>

<p>Using the annotation <code>@Annotations\QueryParam</code>, is very easy to get the <code>offset</code>, and <code>limit</code> that is ORM-ready :). </p>

<p>This is the <code>PageHandler::all</code>:</p>

<pre><code>/**
 * Get a list of Pages.
 *
 * @param int $limit  the limit of the result
 * @param int $offset starting from the offset
 *
 * @return array
 */
public function all($limit = 5, $offset = 0, $orderby = null)
{
    return $this-&gt;repository-&gt;findBy(array(), $orderby, $limit, $offset);
}
</code></pre>

<h3 id="pagination-with-headers">Pagination with headers</h3>

<p>Is possible to include pagination into the headers, there is a RFC: <a href="http://tools.ietf.org/html/rfc5988#page-6">Link header introduced by RFC 5988</a>,
you could find a good implementation on the <a href="http://developer.github.com/v3/#pagination">github pagination documentation</a>.</p>

<blockquote>
<b>Link Header</b><br />
The pagination info is included in the Link header. It is important to follow these Link header values instead of constructing your own URLs. In some instances, such as in the Commits API, pagination is based on SHA1 and not on page number.<small>github link header</small>
</blockquote>

<p>github example: </p>

<pre><code>Link: &lt;https://api.github.com/user/repos?page=3&amp;per_page=100&gt;; rel="next",&lt;https://api.github.com/user/repos?page=50&amp;per_page=100&gt;; rel="last"
</code></pre>

<h2 id="symfony2-goodies">Symfony2 goodies</h2>

<h3 id="head-method">HEAD method</h3>

<p>In Symfony2 the HEAD method follows the same routes and settings of the GET method,
if you have the GET method available you will also have the <code>HEAD</code> that links to the same actions,
the response will be empty.</p>

<h3 id="patching-the-patch-problem">Patching the PATCH problem</h3>

<p>Some browser doesn&#8217;t support some methods as <code>PUT</code>, <code>PATCH</code> and <code>DELETE</code> HTTP methods:</p>

<blockquote>
    Fortunately Symfony2 provides you with a simple way of working around this limitation.<br />
     By including a _method parameter in the query string or parameters of an HTTP request,
     Symfony2 will use this as the method when matching routes. <br />
     Forms automatically include a hidden field for this parameter if their submission method is not GET or POST.<br />
      See the related chapter in the forms documentation for more information.
    <small>http://symfony.com/doc/current/cookbook/routing/method_parameters.html#faking-the-method-with-method</small>
</blockquote>

<h2 id="disable-csrf-with-rest">Disable CSRF with REST</h2>

<h3 id="theory-on-cross-site-request-forgery">Theory on Cross-site request forgery</h3>

<p>If you don&#8217;t know what CSFR is there is lot of documentation on internet, please have a look to the <a href="http://symfony.com/doc/current/book/forms.html#csrf-protection">csrf-protection</a></p>

<blockquote>
CSRF protection works by adding a hidden field to your form - called _token by default - that contains a value that only you and your user knows. This ensures that the user - not some other entity - is submitting the given data. Symfony automatically validates the presence and accuracy of this token.
<small>http://symfony.com/doc/current/book/forms.html#csrf-protection</small>
</blockquote>

<h3 id="csrf-and-rest">CSRF and REST</h3>

<p>Is possible to disable the CSRF based on the user&#8217;s role, the documentation on Friend-Of-Symfony repository is self-explanatory:
<a href="https://github.com/FriendsOfSymfony/FOSRestBundle/blob/master/Resources/doc/2-the-view-layer.md#CSRF-validation">FOSRestBundle doc CSRF validation</a>.</p>

<p>We need to associate the <code>ROLE_API</code> to the REST users:</p>

<pre><code># app/config/security.yml
providers:
    in_memory:
        memory:
            users:
                user:  { password: userpass, roles: [ 'ROLE_USER', 'ROLE_API' ] }
                admin: { password: adminpass, roles: [ 'ROLE_ADMIN', 'ROLE_API' ] }
</code></pre>

<p>then in the config.yml we need to enable the feature</p>

<pre><code># app/config/config.yml
fos_rest:
    disable_csrf_role: ROLE_API
</code></pre>

<p>We have now to modify the functional tests adding the authentication: </p>

<pre><code>// /src/Acme/BlogBundle/Tests/Controller/PageControllerTest.php
public function setUp()
{
    $this-&gt;auth = array(
        'PHP_AUTH_USER' =&gt; 'user',
        'PHP_AUTH_PW'   =&gt; 'userpass',
    );

    $this-&gt;client = static::createClient(array(), $this-&gt;auth);
}
</code></pre>

<p><strong>EDITED 2-gen-2014</strong> </p>

<p>Adding <code>disable_csrf_role</code> you should add the basic auth to the CURL call:</p>

<pre><code>curl -X POST -d '{"title":"title","body":"body"}' \
 http://localhost:8000/api/v1/pages.json \
 --header "Content-Type:application/json" --user user:userpass
</code></pre>

<h2 id="different-points-of-view">Different points of view</h2>

<p>It is very common when the API should serves different fields according to the role of the user that requests a resource.</p>

<p>For example the field <code>state</code> that determines whether the page is public or not, can only be viewed and changed by the administrator.
There are also more complex scenario, eg. the same field may follow different validations.</p>

<p>How to handle those differences on the same Page Entity?</p>

<p>There are many ways: validation groups, using serialization groups, or use different forms.</p>

<h3 id="the-form-is-the-resource">The form is the resource</h3>

<p>I personally prefer the form, an idea could be associate a form to a role. 
Given the same URI, if the user was authenticated as an administrator would use the <code>PageAdminType</code> form, otherwise she/he would use the <code>PageUserType</code>.</p>

<p>But this idea of associating a form to a role, does not fully comply with the REST philosophy,
 each request should be made to the desired resource, but technically the forms are different.</p>

<p>The URI should indicate which resource you want, and the layer of authorization should only accept or reject your request.</p>

<p>In the article part2, we have already seen that the resource we receive in input is not the entity Page, but it is the <code>pageType</code> form, the API uses as interface the <code>pageType</code> form.</p>

<p>Maybe the best option is use different URIs for different form and role.</p>

<ol>
  <li>
    <p><code>api/v1/pages/</code>, the form is the standard <code>PageType</code>.</p>
  </li>
  <li>
    <p><code>api/v1/admin/pages/</code> the form used will have more fields and different authentication.</p>
  </li>
</ol>

<p>We just apply the definition of Resource not to the Entity but to the form.</p>

<h2 id="the-perfection">The perfection?</h2>

<p>In the enterprise the perfect software is when timing, clean-code and maintenance are in the correct balance with the specifications.</p>

<p>In the open-source and in the Symfony ecosystem developers tend to do their best,
it would be possible to improve our application and our bundle?</p>

<h3 id="thin-bundle-fat-library">Thin Bundle, Fat library.</h3>

<p>We could improve the loose coupling leaving in the bundle only the files that are truly related to Symfony
and create a library for the entities, forms and services. But this could be another topic a blog post :).</p>

<h2 id="recap">Recap</h2>

<p>We are in the end of this epic tale, this recapitulate should contain few concepts:</p>

<ol>
  <li>
    <p>We have created a smart service <code>PageHandler</code> where all the logic about the page is.</p>
  </li>
  <li>
    <p>The service <code>PageHandler</code> is an API for all the Symfony application,
it respects the Interface <code>PageHandlerInterface</code>, and is available in the container.</p>
  </li>
  <li>
    <p>We have developed a controller <code>PageController</code>, the actions have @docblock annotations in order to decorate the View,
those annotations also create the documentation, and provide a parameters filtering.</p>
  </li>
  <li>
    <p>The form is very important in this REST application, the form is the input for our PUT/PATCH/POST methods,
it also validates and hydrates the object.</p>
  </li>
  <li>
    <p>The form could also be the resource named by the URI.</p>
  </li>
  <li>
    <p>We have defined what is the meaning of <code>idempotent</code> and why <code>PUT</code> should also create the resource.</p>
  </li>
</ol>

<p>There are a lot of concepts about REST that I won&#8217;t cover here like RESTFul, HAL, OAuth &#8230;</p>

<p>The <a href="https://github.com/liuggio/symfony2-rest-api-the-best-2013-way">repository</a> contains all the functions and the tests that we have seen during those articles.</p>

<h5 id="have-a-rest">Have a REST.</h5>

<p>That is all for the 2013</p>

<h3 id="resources">Resources</h3>

<p><a href="http://tools.ietf.org/html/rfc1945#page-24">RFC1945 Request-URI</a></p>

<p><a href="http://tools.ietf.org/html/rfc5988#page-6">RFC5988 Web Linking</a></p>

<p><a href="http://developer.github.com/v3/">REST API at github.com/v3/</a></p>

<p><a href="https://github.com/gimler/symfony-rest-edition">gimler/symfony rest edition</a></p>

<p><a href="http://symfony.com/doc/current/cookbook/routing/method_parameters.html#faking-the-method-with-method">Symfony Faking the Method</a></p>

<p><a href="http://idbentley.com/blog/2013/03/14/should-restful-apis-include-relationships/">should-restful-apis-include-relationships/</a></p>

<p><a href="http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">best-practices-for-a-pragmatic-restful-api</a></p>

    </article>
    <hr>
    <div id="related">
      <h3>Related Posts</h3>
      <ul class="posts">
      
      <li>
       <span>30 Sep 2014 &raquo;</span> <a href="/speedup-symfony-functional-tests-phpunit">Speed up PHPUnit and functional tests with Symfony and fastest</a>
      </li>
      
      <li>
       <span>31 Aug 2014 &raquo;</span> <a href="/price-more-then-money-php-library">Price: more then Money - PHP library</a>
      </li>
      
      <li>
       <span>05 May 2014 &raquo;</span> <a href="/best-resources-about-symfony-tdd-bdd-ddd-methologies">(my) Best resources about methodologies on Symfony, PHP, DDD, BDD ...</a>
      </li>
      
      </ul>
    </div>
    
    <div class="pagination">
        <ul class="pager span9">
            
            <li class="prev span3"><a href="/web-api-rest-with-symfony2-the-best-way-the-post-method" title="part2 - Web API REST with Symfony2"><i class="icon-arrow-left"></i><br>
                Previous - part2 - Web API REST with Symfony2</a></li>
            
            <li  class="span2 center"><a style=" width: 100%;" href="/index.html"><br>Archive</a></li>
            
            <li class="next span3"><a href="/persist-the-money-doctrine-value-object" title="Persist the Money, Doctrine Value Object"><i class="icon-arrow-right"></i> <br>Next - Persist the Money, Doctrine Value Object</a>
            </li>
            
        </ul>
    </div>
    
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'welcometothebundle'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</div>
  
 



            </div>
        </div>
    </section>
</div>

<footer class="footer">
      <div class="container">
        <div class="span3 offset1">
            <ul class="nav nav-pills nav-stacked"> 
                <li class="nav-header">Open Source</li>                
                <li><a href="http://leaphly.org">leaphly <small>cart built around REST specs.</small></a></li>
                <li><a href="https://poser.pugx.org/">badge-poser <small>badges for composer</small></a></li>
                <li><a href="https://github.com/PUGX/godfather">godfather <small>php strategy pattern</small></a></li>
                <li><a href="https://github.com/liuggio/statsd-php-client">statsd-php-client <img class="pull-right" style="max-width:80px;margin-right:30px"  alt="Total Downloads" src="https://poser.pugx.org/liuggio/statsd-php-client/downloads.png"></a></li>
                <li><a href="https://github.com/liuggio/ExcelBundle">sf2 Excel bundle <img class="pull-right" style="max-width:80px;margin-right:30px" alt="Total Downloads" src="https://poser.pugx.org/liuggio/ExcelBundle/downloads.png"></a></li>
                 <li><a href="https://github.com/liuggio?tab=repositories"><small>more...</small></a></li>
            </ul>

        </div>



        <div  class="span2 offset1" >
            <ul class="nav nav-pills nav-stacked left">
            <li class="nav-header">Categories</li>
                <li><a href="/categories.html#tutorial-ref">
                    Tutorial
                </a></li>
                <li><a href="/categories.html#blah-blah-blah-ref">
                    Blah-blah-blah
                </a></li>
                <li><a href="/categories.html#post-ref">
                    Post
                </a></li>
                <li><a href="/categories.html#talk-ref">
                    Talk
                </a></li>
            </ul>
        </div>

        <div  class="span2 offset1" >
            <ul class="nav nav-pills nav-stacked"> 
            <li class="nav-header">Connect</li>
                <li><a href="https://github.com/liuggio" title="Giulio De Donato github projects"
                       target="_blank"
                       class="social"><img src="/assets/themes/readable-liuggio/img/github.png" width="13"> github</a></li>
                <li><a href="http://twitter.com/liuggio" title="Giulio De Donato twitter page"
                       target="_blank"
                       class="social"><i class="icon-twitter"></i> twitter</a></li>
                <li><a href="http://www.linkedin.com/profile/view?id=94597934"
                       title="Giulio De Donato Linkedin profile" target="_blank"
                       class="social">
                       <i class="icon-linkedin"></i> linkedin</a></li>
                <li><a href="http://www.slideshare.net/liuggio"
                       title="Giulio De Donato slideshare presentations" target="_blank"
                       class="social">
                       <img src="/assets/themes/readable-liuggio/img/slide.png" width="13"> slideshare
                       </a></li>
            </ul>
        </div>     
      </div>
      <p>© Giulio De Donato, 2013 — built with <a href="http://jekyllrb.com/">Jekyll.</a>
          <a href="http://welcometothebundle.com/feed.xml" title="feed" target="_blank">RSS feed</a>.
      </p>
    </footer>

<!-- /container -->
<script src="/assets/themes/readable-liuggio/bootstrap/js/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="/assets/themes/readable-liuggio/js/highlight.pack.js" type="text/javascript"></script>
<script src="/assets/themes/readable-liuggio/js/uitotop-jquery-plugin.js" type="text/javascript"></script>
<script src="/assets/themes/readable-liuggio/js/cloud.js" type="text/javascript"></script>


<script type="text/javascript">
    var links = document.links;
    for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if (links[i].hostname.replace("www.", "") != window.location.hostname.replace("www.", "") ) {
            links[i].target = '_blank';
        }
    }

    var links = document.links;
    for (var i = 0, linksLength = links.length; i < linksLength; i++) {

        if (links[i].href == 'http://www.slideshare.net/liuggio/rationally-boost-your-symfony2-application-with-caching-tips-and-monitoring') {

            //dirty solution in order to add slideshare frame into github Jekyll
            links[i].innerHTML = '<iframe src="http://www.slideshare.net/slideshow/embed_code/14625769?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/rationally-boost-your-symfony2-application-with-caching-tips-and-monitoring/?no" title="Rationally boost your symfony2 application with caching tips and monitoring" target="_blank">Rationally boost your symfony2 application with caching tips and monitoring</a></div>';
            break;
        } else if (links[i].href == 'http://www.slideshare.net/liuggio/its-all-about-behaviour-also-in-php') {
            links[i].innerHTML = '<iframe src="http://www.slideshare.net/slideshow/embed_code/27465974?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/its-all-about-behaviour-also-in-php/?no" title="It is all about behaviour also in php. PHP loves BDD." target="_blank">It is all about behaviour also in php. PHP loves BDD.</a></div>';
        } else if (links[i].href == 'http://www.slideshare.net/liuggio/design-pattern-symfony2') {
            links[i].innerHTML = '<div class="centered center"><iframe src="http://www.slideshare.net/slideshow/embed_code/27449969?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/design-pattern-symfony2/?no" title="Design pattern symfony2 - Nanos gigantium humeris insidentes" target="_blank">Design pattern Symfony2 - Nanos gigantium humeris insidentes</a></div></div>';
        } else if (links[i].href == 'http://www.slideshare.net/liuggio/caching-and-data-analysis-will-move-your-symfony2-application-to-the-next-level') {
            links[i].innerHTML = '<div class="centered center"><iframe src="http://www.slideshare.net/slideshow/embed_code/21395241?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/caching-and-data-analysis-will-move-your-symfony2-application-to-the-next-level?no" title="Caching and data analysis will move your Symfony2 application to the next level" target="_blank">Caching and data analysis will move your Symfony2 application to the next level</a></div></div>';
        }
    }

</script>
<script type="text/javascript">
  var analytics=analytics||[];analytics.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+e+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);var r=function(e){return function(){analytics.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["identify","track","trackLink","trackForm","trackClick","trackSubmit","pageview","ab","alias","ready"];for(var s=0;s<i.length;s++)analytics[i[s]]=r(i[s])};
  analytics.load("wdoo4hzofo");
</script>

<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37195869-1']);
    _gaq.push(['_trackPageview']);

    (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();

</script>


<script>
    $(function () { // document ready
        if (!!$('.sticky').offset()) { // make sure ".sticky" element exists
            var stickyTop = $('.sticky').offset().top; // returns number
            $(window).scroll(function () { // scroll event
                $('#sticky-pagination').show().removeClass("hidden");
                var windowTop = $(window).scrollTop(); // returns number
                if (stickyTop < windowTop) {
                    $('.sticky').css({ position:'fixed', top:0, right:0 });
                    $('.sticky').addClass("well");
                    $('.sticky .inner').show();

                }
                else {
                    $('.sticky').css('position', 'static');
                    $('.sticky').removeClass("well").addClass("span1");
                    $('.sticky .inner').hide();
                    $('#sticky-pagination').hide();
                }
            });
        }
    });
</script>

 <script>
        //syntax highlight
        $(document).ready(function() {
            $('pre code').each(function(i, e) {hljs.highlightBlock(e)});
        });
    </script>
<script type="text/javascript">
    $.fn.tagcloud.defaults = {
      size: {start: 10, end: 20, unit: 'px'},
      color: {start: '#CD4540', end: '9C2520'}
    };

    $(function () {
      $('ul.tag_box li a').tagcloud();
    });
</script>

<script>
$(document).ready(function() {
    $('h2, h3, h4, h5').each(function(i, e) {
        var a = '<a class="headerlink" href="#'+e.id+'" name="#'+e.id+'" title="Permalink to this headline">¶</a>';
        $(e).append(a);
    });
});

$().UItoTop();

</script>


</body>
</html>

