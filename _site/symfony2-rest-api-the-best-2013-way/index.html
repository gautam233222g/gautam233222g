
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Symfony2 REST API: the best way</title>
    
    <meta name="description" content="REST API tutorial on symfony2">
    
    <meta name="author" content="Giulio De Donato">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="/assets/themes/readable-liuggio/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/readable-liuggio/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/readable-liuggio/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/readable-liuggio/js/styles/github.css" rel="stylesheet">
    <link href="/assets/themes/readable-liuggio/js/uitotop-jquery-plugin.css" rel="stylesheet">
    <!-- Google Web Font-->
    <link href='http://fonts.googleapis.com/css?family=Lato:400,400italic,900italic,300' rel='stylesheet' type='text/css'>
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="" href="http://welcometothebundle.com/feed.xml">

    <link rel="shortcut icon" href="/assets/themes/readable-liuggio/img/icon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg" />

</head>
<body>
<div class="container">
    <header>
        <div id="header">
            <div class="logo span6"><img src="/assets/themes/readable-liuggio/img/welcometothebundle-logo.svg"></div>
            <h2><a title="Blog of Giulio De Donato" id="sitename" href="http://www.welcometothebundle.com/">Welcome to the bundle</a></h2>  
            
            <p>Best Practices, Symfony2, developing, and blah blah blah.</p>
            
        </div>
    </header>

<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
    <section id="content">
        <div class="row">
            <aside class="span3">
                <div class="well boxed profile">
                    <p align="center"><img
                            src="http://www.gravatar.com/avatar/662a52953053d94a145a00df9da9f0d2.png?size=48" class="img-rounded">
                    </p>
                    <p style="font-size:95%">I'm liuggio 
                    (aka <a href="https://plus.google.com/115690008178168800202?rel=author" rel="author" title="Giulio De Donato">Giulio De Donato</a>)
                         tons of lines of code ago I took a degree in Computer Science, I'm the
                        lead developer at Terravision. I can't stop studying, you could find me in some conferences, I'm a proud member of <a href="http://roma.grusp.org/">PHP user group</a>, 
                        and right now I'm in <a href="https://maps.google.it/maps?q=vatican+city&hnear=Vatican+City&gl=it&t=h&z=16">the center of Rome</a>.</p>
                        <p><strong>ps: I love open-source.</strong></p>
                </div>
                <!-- start sticky section
#################################################
                -->
                <div class="well social boxed">
                    <div class="center" align="center">
                        <a href="https://github.com/liuggio" title="Giulio De Donato github projects"
                           target="_blank"><img src="/assets/themes/readable-liuggio/img/github.png" width="32"></a>
                        <a href="http://twitter.com/liuggio" title="Giulio De Donato twitter page"
                           target="_blank"><i class="icon-twitter"></i></a>
                        <a href="http://www.linkedin.com/profile/view?id=94597934"
                           title="Giulio De Donato Linkedin profile" target="_blank">
                           <i class="icon-linkedin"></i></a>
                        <a href="http://www.slideshare.net/liuggio"
                           title="Giulio De Donato slideshare presentations" target="_blank">
                           <img src="/assets/themes/readable-liuggio/img/slide.png" width="32">
                           </a>
                    </div>
                    <div class="center">
                        <div align="center" class="twitter-cnt">
                            <a href="https://twitter.com/liuggio" class="twitter-follow-button"
                               data-show-count="false" data-size="large" data-dnt="true" title="Follow Giulio De Donato">Follow
                                @liuggio</a>
                            <script>!function (d, s, id) {
                                var js, fjs = d.getElementsByTagName(s)[0];
                                if (!d.getElementById(id)) {
                                    js = d.createElement(s);
                                    js.id = id;
                                    js.src = "//platform.twitter.com/widgets.js";
                                    fjs.parentNode.insertBefore(js, fjs);
                                }
                            }(document, "script", "twitter-wjs");</script>
                        </div>
                    </div>
                </div>

                <!-- end sticky section
                ================================================== -->
                <div class="boxed categories">
                    
                    <ul class="nav nav-tabs nav-stacked">
                        
                        


  
     
    	<li><a href="/categories.html#post-ref">
    		post
    	</a></li>
     
    	<li><a href="/categories.html#tutorial-ref">
    		tutorial
    	</a></li>
     
    	<li><a href="/categories.html#talk-ref">
    		talk
    	</a></li>
     
    	<li><a href="/categories.html#blah-blah-blah-ref">
    		blah-blah-blah
    	</a></li>
    
  


                    </ul>
                </div>
                
                <div class="boxed cloud">
                    <h3>Tags</h3>
                    <ul class="tag_box">
                        
                        


  
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#assetic-ref" rel="2">assetic <span>2</span></a></li>
     
    	<li class="tag-list tag-size-11"><a href="/tags.html#symfony2-ref" rel="11">symfony2 <span>11</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#bundle-ref" rel="3">bundle <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#github-ref" rel="1">github <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#bitbucket-ref" rel="1">bitbucket <span>1</span></a></li>
     
    	<li class="tag-list tag-size-13"><a href="/tags.html#PHP-ref" rel="13">PHP <span>13</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#assets-ref" rel="3">assets <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#rackspace-ref" rel="1">rackspace <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#CDN-ref" rel="1">CDN <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#monitoring-ref" rel="1">monitoring <span>1</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#statsd-ref" rel="3">statsd <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#vagrant-ref" rel="1">vagrant <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#graphite-ref" rel="1">graphite <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#tvision-ref" rel="1">tvision <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#team-ref" rel="1">team <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#coding-ref" rel="1">coding <span>1</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#conference-ref" rel="2">conference <span>2</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#cache-ref" rel="3">cache <span>3</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#optimization-ref" rel="1">optimization <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#servergrove-ref" rel="1">servergrove <span>1</span></a></li>
     
    	<li class="tag-list tag-size-4"><a href="/tags.html#phpunit-ref" rel="4">phpunit <span>4</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#guard-ref" rel="1">guard <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#automate-ref" rel="1">automate <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#code-inspection-ref" rel="1">code-inspection <span>1</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#TDD-ref" rel="2">TDD <span>2</span></a></li>
     
    	<li class="tag-list tag-size-4"><a href="/tags.html#BDD-ref" rel="4">BDD <span>4</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#test-ref" rel="3">test <span>3</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#phpspec-ref" rel="2">phpspec <span>2</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#HTTP-ref" rel="1">HTTP <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#APC-ref" rel="1">APC <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#redis-ref" rel="1">redis <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#doctrine2-ref" rel="1">doctrine2 <span>1</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#doctrine-ref" rel="2">doctrine <span>2</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#php-internal-ref" rel="1">php-internal <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#interface-ref" rel="1">interface <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#design-patterns-ref" rel="1">design-patterns <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#talk-ref" rel="1">talk <span>1</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#rest-ref" rel="3">rest <span>3</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#api-ref" rel="3">api <span>3</span></a></li>
     
    	<li class="tag-list tag-size-4"><a href="/tags.html#DDD-ref" rel="4">DDD <span>4</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#value objects-ref" rel="2">value objects <span>2</span></a></li>
     
    	<li class="tag-list tag-size-2"><a href="/tags.html#money-ref" rel="2">money <span>2</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#symfony-ref" rel="1">symfony <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#price-ref" rel="1">price <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#fixture-ref" rel="1">fixture <span>1</span></a></li>
     
    	<li class="tag-list tag-size-1"><a href="/tags.html#functional-ref" rel="1">functional <span>1</span></a></li>
    
  



                    </ul>
                </div>

                
                    <div id="related" class="boxed">
                    <h3>Related Posts</h3>
                    <ul class="posts">
                    
                    <li>
                      <a href="/speedup-symfony-functional-tests-phpunit">Speed up PHPUnit and functional tests with Symfony and fastest</a>
                    </li>
                    
                    <li>
                      <a href="/price-more-then-money-php-library">Price: more then Money - PHP library</a>
                    </li>
                    
                    <li>
                      <a href="/best-resources-about-symfony-tdd-bdd-ddd-methologies">(my) Best resources about methodologies on Symfony, PHP, DDD, BDD ...</a>
                    </li>
                    
                    <li>
                      <a href="/domain-driven-design-and-symfony-for-simple-app">Domain Driven Design principles with Symfony2 also for dummy applications</a>
                    </li>
                    
                    <li>
                      <a href="/persist-the-money-doctrine-value-object">Persist the Money, Doctrine Value Object</a>
                    </li>
                    
                    </ul>
                    </div>
                
            </aside>

            <!-- start content section
            ================================================== -->
            <div class="span9">
                

<div class="span9">
    <div class="page-header">
        <div class="row">
            <h1 class="span8">Symfony2 REST API: the best way 
            </h1>
          <div class="span1 right bottom sticky center">
              
              <div id="edit-github">
                  <a class="btn btn-mini" target="_blank" href="https://github.com/liuggio/liuggio.github.com/edit/master/_posts/2013-11-09-symfony2-rest-api-the-best-2013-way.md" title="Found a typo? Please edit it on Github"><i class="icon-edit pull-left"></i><b>Fix</b></a>
              </div>
              

              <div id="sticky-pagination" class="hidden">
                  
                      <a class="btn-mini pull-left" target="_blank" href="/symfony2-design-patterns" title="Symfony2 design patterns @ symfonyday">
                          <i class="icon-arrow-left"></i>
                      </a>
                  

                  
                  <a class="btn-mini pull-right" target="_blank" href="/web-api-rest-with-symfony2-the-best-way-the-post-method" title="part2 - Web API REST with Symfony2">
                      <i class="icon-arrow-right"></i>
                  </a>
                  
              </div>

               <a href="https://twitter.com/share" class="twitter-share-button" data-via="liuggio" data-size="large"
                  data-count="none">Tweet</a>
               <script>!function (d, s, id) {
                   var js, fjs = d.getElementsByTagName(s)[0];
                   if (!d.getElementById(id)) {
                       js = d.createElement(s);
                       js.id = id;
                       js.src = "//platform.twitter.com/widgets.js";
                       fjs.parentNode.insertBefore(js, fjs);
                   }
               }(document, "script", "twitter-wjs");</script>
           </div>
        </div>
        <hr>
        <div class="row">
            <div class="span4">
                <div class="date"><span>13 November 2013</span></div>
            </div>

            <div class="span5">
                
                <ul class="tag_box">
                    
                    


  
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#rest-ref">rest <span>3</span></a></li>
     
    	<li class="tag-list tag-size-3"><a href="/tags.html#api-ref">api <span>3</span></a></li>
     
    	<li class="tag-list tag-size-11"><a href="/tags.html#symfony2-ref">symfony2 <span>11</span></a></li>
    
  



                </ul>
                
            </div>
        </div>
    </div>
    <article>
        
<h3 id="part-1---the-get">Part 1 - the <code>GET</code></h3>

<p>Here’s another nice guide on how to create an API with Symfony2, this is the <strong>part 1</strong> of a series of articles.</p>

<p>Here you could find the <a href="/web-api-rest-with-symfony2-the-best-way-the-post-method/">Part2 - the ‘POST’</a>,
and the last article <a href="/symfony2-rest-api-the-best-way-part-3/">Part3 - The rest of REST</a></p>

<p>I would like to be short and concise bringing practical examples.</p>

<p>I would not talk about the difference between REST and RESTful <a href="http://martinfowler.com/articles/richardsonMaturityModel.html">Martin Fowler Maturity Model</a>.</p>

<p>The title of this series is just because I’ve found a lot of great ideas from the <a href="http://williamdurand.fr/2012/08/02/rest-apis-with-symfony2-the-right-way/">William Durand: rest-apis-with-symfony2-the-right-way</a> blog written in 2012, so this is a revisited version, talking more about form, and services.</p>

<h2 id="motivation">Motivation</h2>

<p>Writing Leaphly <a href="http://leaphly.org">symfony cart rest</a> we had few problems finding a tutorial or a blog post that could show us how to properly use REST and symfony2 with forms and doctrine.</p>

<h2 id="goal">GOAL</h2>

<p>We are going to create an application that serves API for Page content with <code>get</code>, <code>put</code>, <code>post</code> and <code>patch</code>, using <a href="http://www.symfony2.com">Symfony2</a>, the <a href="https://github.com/FriendsOfSymfony/FOSRestBundle">FOSRestBundle</a>, the <a href="https://github.com/nelmio/NelmioApiDocBundle">NelmioApiDocBundle</a>, the <a href="https://github.com/schmittjoh/JMSSerializerBundle">JSMSerializerBundle</a>, and <a href="http://www.doctrine-project.org">Doctrine</a>.</p>

<p>The real objective is create an application that shows some best practices and rules with Symfony2 and REST:</p>

<h3 id="rules">Rules</h3>

<ol>
  <li>Interface as contracts.</li>
  <li>Thin Controller, Fat Service.</li>
  <li>The <code>Content Negotiation</code> in the HTTP and REST.</li>
  <li>Form as API interface.</li>
</ol>

<h2 id="the-github-repository">The github repository</h2>

<p>There’s a repository at <a href="https://github.com/liuggio/symfony2-rest-api-the-best-2013-way/">liuggio/symfony2-rest-api-the-best-2013-way</a>
you could see the working code using the tag <code>part1</code> with</p>

<pre><code>php composer.phar create-project liuggio/symfony2-rest-api-the-best-2013-way blog-rest-symfony2 -sdev
cd blog-rest-symfony2
git checkout -f part1
php app/console doctrine:database:create
php app/console doctrine:schema:create
bin/phpunit -c app
</code></pre>

<p>All the tags for the demo project at <a href="https://github.com/liuggio/symfony2-rest-api-the-best-2013-way/tags">tags</a></p>

<h2 id="step-1a-the-application">Step 1.A The application</h2>

<p>Create a Symfony application</p>

<pre><code>php composer.phar create-project symfony/framework-standard-edition BlogRESTAPI/
cd BlogRESTAPI
php composer.phar require "friendsofsymfony/rest-bundle" "@dev"
php composer.phar require "jms/serializer-bundle" "@dev"
php composer.phar require "nelmio/api-doc-bundle" "@dev"
</code></pre>

<p>then we had to configure the bundles properly and add to the appKernel.php</p>

<pre><code>// app/AppKernel.php
$bundles = array(
    //..
    new FOS\RestBundle\FOSRestBundle(),
    new JMS\SerializerBundle\JMSSerializerBundle(),
    new Nelmio\ApiDocBundle\NelmioApiDocBundle(),
</code></pre>

<h2 id="step-1b-the-blog-bundle">Step 1.B The Blog Bundle</h2>

<p>We are going to create a REST controller for the Page Entity,
in your symfony2 standard application we need to create the bundle:</p>

<pre><code>php app/console generate:bundle --namespace=Acme/BlogBundle --dir=src --no-interaction
</code></pre>

<h2 id="step-1c-the-model">Step 1.C The Model</h2>

<p>We are going to create an Entity called <code>Page</code> with <code>text</code> and <code>body</code>:</p>

<pre><code>php app/console doctrine:generate:entity --entity=AcmeBlogBundle:Page \
  --format=annotation --fields="title:string(255) body:text" \
  --no-interaction
php app/console doctrine:database:create
php app/console doctrine:schema:create
</code></pre>

<h2 id="step-1d-the-page-form">Step 1.D The Page Form</h2>

<p>Now we need the form for that entity, another generator command :)</p>

<pre><code>php app/console doctrine:generate:form AcmeBlogBundle:Page --no-interaction
</code></pre>

<h2 id="step-2---start-with-rest">Step 2 - Start with Rest</h2>

<h3 id="step-2a---the-functional-test">Step 2.A - The functional test</h3>

<p>We want to create a function that when it’s called it returns the resource
with the format requested.</p>

<p>Any good controller should start with a Functional test, but in order to reduce the verbosity I’ll talk about functional test later, see the section 3.C below.</p>

<pre><code>1. /api/v1/pages/{id}.{_format}
2. /api/v1/pages/{id}.json  # will return a json file
3. /api/v1/pages/{id}.xml   # will return a xml file
4. /api/v1/pages/{id} and /api/1/pages/{id}.html  # will return the web page file
</code></pre>

<p>We’ll see later how to not explicitly specify the format, and how to use and set-up correctly the content-negotiation using HTTP Headers.</p>

<h3 id="step-2b---the-controller">Step 2.B - The controller</h3>

<p>We want to create the controller class</p>

<pre><code>// /src/Acme/BlogBundle/Controller/PageController.php
class PageController extends FOSRestController
</code></pre>

<p>and then we add a simple and dirty function (we’ll refactor soon)</p>

<pre><code>public function getPageAction($id)
{
    return $this-&gt;container-&gt;get('doctrine.entity_manager')-&gt;getRepository('Page')-&gt;find($id);
}
</code></pre>

<h4 id="edit-14112013-samuel-gordalina-suggests"><strong>EDIT-14/11/2013</strong> Samuel Gordalina suggests:</h4>

<p>You can use ParamConverter which fetches an entity from database or returns a 404 exception.
For more info see <a href="https://github.com/gordalina/sample-twitter-api-symfony2/blob/master/src/Twitter/ApiBundle/Controller/TweetController.php#L37">sample-twitter-api-symfony2:37</a></p>

<h3 id="step-2c---adding-the-routes">Step 2.C - Adding the routes</h3>

<p>Add to the route file </p>

<pre><code># /app/config/routing.yml
acme_blog:
    type: rest
    prefix: /api
    resource: "@AcmeBlogBundle/Resources/config/routes.yml"
</code></pre>

<p>Create a route file into the bundle:</p>

<pre><code># /src/Acme/BlogBundle/Resources/config/routes.yml
acme_blog_Page:
    type: rest
    prefix: /v1
    resource: "Acme\BlogBundle\Controller\PageController"
    name_prefix:  api_1_ # naming collision
</code></pre>

<p>check all the API routes with:</p>

<pre><code>app/console route:debug | grep api
</code></pre>

<p>it should contain the <code>api_1_get_page</code></p>

<p>So we now have a route, and a controller that responses to the get(id) with the Page resource,
is that what we wanted?</p>

<p>Yes but we could do better.</p>

<h2 id="step-3---refactoring">Step 3 - Refactoring</h2>

<p>OMG we have only created a little Controller, why we need to refactor?</p>

<p>As I said we are trying to do things at our best, while this may seem over-engineering, 
in later articles we will see how take advantage of the changes made.</p>

<h3 id="step-3a---interface-as-contract">Step 3.A - Interface as contract</h3>

<blockquote>
Type hinting the injected object means that you can be sure that a suitable dependency has been injected.
By type-hinting, you'll get a clear error immediately if an unsuitable dependency is injected.
By type hinting using an interface rather than a class you can make the choice of dependency more flexible.
And assuming you only use methods defined in the interface, you can gain that flexibility and still safely use the object.
 <small> from <cite title="Source Title">sf2 - symfony.com</cite></small>
</blockquote>

<p>Following this as first rule, we need to create an interface in <code>/src/Acme/BlogBundle/Model/PageInterface.php</code> and then put <code>implements PageInterface</code> in the entity <code>Page</code>.</p>

<h3 id="step-3b---the-page-handler">Step 3.B - The Page Handler</h3>

<p>In order to remove all the logic from the <code>PageController</code>,
we have to create a service, we call it <code>PageHandler</code> in <code>/src/Acme/BlogBundle/Handler/PageHandler.php</code>.</p>

<p>The test for the the <code>PageHandler</code> looks something like:</p>

<pre><code>// /src/Acme/BlogBundle/Tests/Handler/PageHandlerTest.php:45
public function testGet()
{
    $id = 1;
    $page = $this-&gt;getPage(); // create a Page object
    // I expect that the Page repository is called with find(1)
    $this-&gt;repository-&gt;expects($this-&gt;once())
        -&gt;method('find')
        -&gt;with($this-&gt;equalTo($id))
        -&gt;will($this-&gt;returnValue($page));

    $this-&gt;pageHandler-&gt;get($id); // call the get.
}
</code></pre>

<p>So it uses <code>find</code> to fetch an <code>id</code> using the doctrine repository.</p>

<p>We are going to create the effective ‘Handler’ that will manage all the transactions to the persistence layer:</p>

<pre><code>// /src/Acme/BlogBundle/Handler/PageHandler.php:16
class PageHandler implements PageHandlerInterface
{
    // ..
    public function __construct(ObjectManager $om, $entityClass)
    {
        $this-&gt;om = $om;
        $this-&gt;entityClass = $entityClass;
        $this-&gt;repository = $this-&gt;om-&gt;getRepository($this-&gt;entityClass);
    }

    // ...
    public function get($id)
    {
        return $this-&gt;repository-&gt;find($id);
    }
}
</code></pre>

<p>We need to make this class available as a service from the dependency injection:</p>

<p>/src/Acme/BlogBundle/Resources/config/services.xml</p>

<pre><code>&lt;parameters&gt;
    &lt;parameter key="acme_blog.page.handler.class"&gt;Acme\BlogBundle\Handler\PageHandler&lt;/parameter&gt;
    &lt;parameter key="acme_blog.page.class"&gt;Acme\BlogBundle\Entity\Page&lt;/parameter&gt;
&lt;/parameters&gt;

&lt;services&gt;
    &lt;service id="acme_blog.page.handler" class="%acme_blog.page.handler.class%"&gt;
        &lt;argument type="service" id="doctrine.orm.entity_manager" /&gt;
        &lt;argument&gt;%acme_blog.page.class%&lt;/argument&gt;
    &lt;/service&gt;
&lt;/services&gt;
</code></pre>

<h3 id="step-3c---thin-controller">Step 3.C - Thin Controller</h3>

<p>Now we have to refactor the controller in order to follow the modification above and use the <code>PageHandler</code>.</p>

<h4 id="the-functional-test-for-the-controller">The functional test for the controller:</h4>

<p>first add to your <code>composer.json</code> the require-dev section:</p>

<pre><code>"require-dev": {
    "doctrine/doctrine-fixtures-bundle": "dev-master",
    "phpunit/phpunit": "3.7.*",
    "liip/functional-test-bundle":"dev-master"
},
</code></pre>

<p>then we have to update the dependencies running <code>php composer.phar update</code></p>

<p>There’s a lot to say about the functional test, we are going to test that when the <code>api_1_get_page</code> is called,
it should return a response with <code>200</code>, the type of the content should be <code>json</code>.</p>

<p>The <code>liip/functional-test-bundle</code> helps us
to handle the fixtures data to the persistence layer before each test.</p>

<p>First we configure <code>fos_rest</code> in order to handle correct format see: <code>/app/config/config.yml:69</code></p>

<p>We have to create the fixture class see <code>/src/Acme/BlogBundle/Tests/Fixtures/Entity/LoadPageData.php</code></p>

<p>and the test:</p>

<pre><code>public function testGet()
{
    $fixtures = array('Acme\BlogBundle\Tests\Fixtures\Entity\LoadPageData');
    $this-&gt;customSetUp($fixtures);
    $page = array_pop(LoadPageData::$pages);

    $route =  $this-&gt;getUrl('api_1_get_page', array('id' =&gt; $page-&gt;getId(), '_format' =&gt; 'json'));
    $this-&gt;client-&gt;request('GET', $route);
    $response = $this-&gt;client-&gt;getResponse();
    $this-&gt;assertJsonResponse($response, 200);
    $content = $response-&gt;getContent();

    $decoded = json_decode($content, true);
    $this-&gt;assertTrue(isset($decoded['id']));
}
</code></pre>

<p>The assertJsonResponse function is well described here: <a href="http://williamdurand.fr/2012/08/02/rest-apis-with-symfony2-the-right-way/#testing">williamdurand-rest-apis-with-symfony2-the-right-way/#testing</a>.</p>

<p>the full test is visible here: /src/Acme/BlogBundle/Tests/Controller/PageControllerTest.php</p>

<p>We have now to modify the function <code>getPage($id)</code>:</p>

<pre><code>// /src/Acme/BlogBundle/Controller/PageController.php

/**
 * Get single Page,
 *
 * @ApiDoc(
 *   resource = true,
 *   description = "Gets a Page for a given id",
 *   output = "Acme\BlogBundle\Entity\Page",
 *   statusCodes = {
 *     200 = "Returned when successful",
 *     404 = "Returned when the page is not found"
 *   }
 * )
 *
 * @Annotations\View(templateVar="page")
 *
 * @param Request $request the request object
 * @param int     $id      the page id
 *
 * @return array
 *
 * @throws NotFoundHttpException when page not exist
 */
public function getPageAction($id)
{
    $page = $this-&gt;container
        -&gt;get('acme_blog.blog_post.handler')
        -&gt;get($id);

    return $page;
}
</code></pre>

<p>executing the test:</p>

<pre><code>bin/phpunit -c app
</code></pre>

<p>Woow green test!</p>

<p>The bundle looks like:</p>

<pre><code>src/Acme/BlogBundle/
    ├── AcmeBlogBundle.php
    ├── Controller
    │   └── PageController.php
    ├── DependencyInjection
    ├── Entity
    │   └── Page.php
    ├── Form
    │   └── PageType.php
    ├── Handler
    │   ├── PageHandlerInterface.php
    │   └── PageHandler.php
    ├── Model
    │   └── PageInterface.php
    ├── Resources
    └── Tests
        ├── Controller
        │   └── PageControllerTest.php
        ├── Fixtures
        │   └── Entity
        │       └── LoadPageData.php
        └── Handler
            └── PageHandlerTest.php
</code></pre>

<h2 id="accessing-to-the-response">Accessing to the response</h2>

<p>Is time to see how the application responses, so executing the php http server</p>

<pre><code>app/console server:run &amp;
</code></pre>

<p>and then accessing to the the resource with <code>wget</code></p>

<pre><code>wget -S  localhost:8000/api/v1/pages/0.html
</code></pre>

<p>We will have a <code>500</code> because the database is empty, and that resource doesn’t exists:</p>

<pre><code>--2013-11-09 15:46:37--  http://localhost:8000/api/v1/pages/0.html
Connecting to localhost (localhost)|127.0.0.1|:8000... connected.
HTTP request sent, awaiting response... 
  HTTP/1.0 500 Internal Server Error
  Content-type: text/html
2013-11-09 15:46:37 ERROR 500: Internal Server Error.
</code></pre>

<p>The resource ‘0’ doesn’t exists,
but we want that the status codes reflects the application behaviour,
so it should return a <code>404</code> resource not found.</p>

<p>We are going to create a private function that throws an Exception if the <code>Page</code> is not found,
the Exception will modify also automatically the Response Header.</p>

<pre><code>/**
 * Fetch the Page or throw a 404 exception.
 *
 * @param mixed $id
 *
 * @return PageInterface
 *
 * @throws NotFoundHttpException
 */
protected function getOr404($id)
{
    if (!($page = $this-&gt;container-&gt;get('acme_blog.blog_post.handler')-&gt;get($id))) {
        throw new NotFoundHttpException(sprintf('The resource \'%s\' was not found.',$id));
    }

    return $page;
}
</code></pre>

<p>The controller now should use this function and
executing <code>wget -S  localhost:8000/api/v1/pages/0.html</code>, we receive a <code>404</code> and we are happy :)</p>

<h2 id="content-negotiation">Content Negotiation</h2>

<p>An important concept developing the REST API is the <a href="http://en.wikipedia.org/wiki/Content_negotiation">Content Negotiation</a>.</p>

<p>If you think that everything is a resource, maybe you care also about the name of the resource,
if the page <code>10</code> is at <code>/api/v1/pages/10</code>, you may want to retrieve the same resource with different content type,
not specifying the <code>format</code> explicitly in the extension <code>/api/v1/pages/10.html</code>, but instead using HTTP <code>Accept</code> header.</p>

<p>[EDIT] removed the tags content-negotiation.
If you want to play with the rest application without the extension, set false to <code>prefer_extension</code> here:<code>https://github.com/liuggio/symfony2-rest-api-the-best-2013-way/blob/master/app/config/config.yml#L102</code>.</p>

<p>Request: <code>curl -i localhost:8000/api/v1/pages/10</code>
No Accept header is sent so the fallback is <code>text/html</code></p>

<pre><code>HTTP/1.1 200 OK
Host: localhost:8000
Content-Type: text/html; charset=UTF-8
Allow: GET

&lt;html&gt;&lt;body&gt;&lt;h1&gt;10- title&lt;/h2&gt;
&lt;p&gt;body&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>So we retrieve the same resource changing the header:</p>

<pre><code>curl -i -H "Accept: application/json"  localhost:8000/api/v1/pages/10
</code></pre>

<p>Tadaaaam the response is a json file:</p>

<pre><code>HTTP/1.1 200 OK
Host: localhost:8000
Content-Type: application/json
Allow: GET

{"id":10,"title":"title","body":"body"}
</code></pre>

<p>We could also send different Content type accepted with different preferences eg:</p>

<pre><code>curl -i -H "Accept: application/json; q=1.0, t/pages/10 q=0.8" localhost:8000/api/v1/
</code></pre>

<p>The response will be a json file as well:</p>

<pre><code>HTTP/1.1 200 OK
Host: localhost:8000
Content-Type: application/json
Allow: GET

{"id":10,"title":"title","body":"body"}
</code></pre>

<h2 id="recap">Recap</h2>

<p>We have created a Doctrine entity called <code>Page</code>, we have identified the methods of the interface that will be very useful later on.
We first created a functional test, then the thin controller without logic.
We have created unit test and then the service <code>PageHandler</code> which instead of the controller, contains the logic to retrieve the information.
We understood the importance of Content Negotiation.</p>

<h2 id="next--create-a-resource-with-api-restweb-api-rest-with-symfony2-the-best-way-the-post-method">Next ›› <a href="/web-api-rest-with-symfony2-the-best-way-the-post-method/">create a resource with API REST</a></h2>

<p>In the next articles, we will describe how to use the page form as shared interface, we will create, modify, and delete Pages, with <code>PUT</code>, <code>PATCH</code>, <code>POST</code>, <code>DELETE</code>, and we will detail how use other important HTTP headers.</p>

<h3 id="references">References:</h3>

<ol>
  <li><a href="http://www.symfony2.com">sf2 - Symfony.com</a></li>
  <li><a href="http://www.youtube.com/watch?v=Kkby5fG89K0">Lukas Kahwe Smith: resting with Sf2 - video</a></li>
  <li><a href="http://williamdurand.fr/2012/08/02/rest-apis-with-symfony2-the-right-way/">William Durand: rest-apis-with-symfony2-the-right-way - blog</a></li>
  <li><a href="https://speakerdeck.com/gordalina/rest-apis-made-easy-with-symfony2">Samuel Gordalina: REST APIs made easy with Symfony2 - slide</a></li>
  <li><a href="http://www.slideshare.net/dlondero/rest-in-practice-27335543">Daniel Londero: Rest in practice - slide</a></li>
</ol>


    </article>
    <hr>
    <div id="related">
      <h3>Related Posts</h3>
      <ul class="posts">
      
      <li>
       <span>30 Sep 2014 &raquo;</span> <a href="/speedup-symfony-functional-tests-phpunit">Speed up PHPUnit and functional tests with Symfony and fastest</a>
      </li>
      
      <li>
       <span>31 Aug 2014 &raquo;</span> <a href="/price-more-then-money-php-library">Price: more then Money - PHP library</a>
      </li>
      
      <li>
       <span>05 May 2014 &raquo;</span> <a href="/best-resources-about-symfony-tdd-bdd-ddd-methologies">(my) Best resources about methodologies on Symfony, PHP, DDD, BDD ...</a>
      </li>
      
      </ul>
    </div>
    
    <div class="pagination">
        <ul class="pager span9">
            
            <li class="prev span3"><a href="/symfony2-design-patterns" title="Symfony2 design patterns @ symfonyday"><i class="icon-arrow-left"></i><br>
                Previous - Symfony2 design patterns @ symfonyday</a></li>
            
            <li  class="span2 center"><a style=" width: 100%;" href="/index.html"><br>Archive</a></li>
            
            <li class="next span3"><a href="/web-api-rest-with-symfony2-the-best-way-the-post-method" title="part2 - Web API REST with Symfony2"><i class="icon-arrow-right"></i> <br>Next - part2 - Web API REST with Symfony2</a>
            </li>
            
        </ul>
    </div>
    
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'welcometothebundle'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




</div>
  
 



            </div>
        </div>
    </section>
</div>

<footer class="footer">
      <div class="container">
        <div class="span3 offset1">
            <ul class="nav nav-pills nav-stacked"> 
                <li class="nav-header">Open Source</li>                
                <li><a href="http://leaphly.org">leaphly <small>cart built around REST specs.</small></a></li>
                <li><a href="https://poser.pugx.org/">badge-poser <small>badges for composer</small></a></li>
                <li><a href="https://github.com/PUGX/godfather">godfather <small>php strategy pattern</small></a></li>
                <li><a href="https://github.com/liuggio/statsd-php-client">statsd-php-client <img class="pull-right" style="max-width:80px;margin-right:30px"  alt="Total Downloads" src="https://poser.pugx.org/liuggio/statsd-php-client/downloads.png"></a></li>
                <li><a href="https://github.com/liuggio/ExcelBundle">sf2 Excel bundle <img class="pull-right" style="max-width:80px;margin-right:30px" alt="Total Downloads" src="https://poser.pugx.org/liuggio/ExcelBundle/downloads.png"></a></li>
                 <li><a href="https://github.com/liuggio?tab=repositories"><small>more...</small></a></li>
            </ul>

        </div>



        <div  class="span2 offset1" >
            <ul class="nav nav-pills nav-stacked left">
            <li class="nav-header">Categories</li>
                <li><a href="/categories.html#tutorial-ref">
                    Tutorial
                </a></li>
                <li><a href="/categories.html#blah-blah-blah-ref">
                    Blah-blah-blah
                </a></li>
                <li><a href="/categories.html#post-ref">
                    Post
                </a></li>
                <li><a href="/categories.html#talk-ref">
                    Talk
                </a></li>
            </ul>
        </div>

        <div  class="span2 offset1" >
            <ul class="nav nav-pills nav-stacked"> 
            <li class="nav-header">Connect</li>
                <li><a href="https://github.com/liuggio" title="Giulio De Donato github projects"
                       target="_blank"
                       class="social"><img src="/assets/themes/readable-liuggio/img/github.png" width="13"> github</a></li>
                <li><a href="http://twitter.com/liuggio" title="Giulio De Donato twitter page"
                       target="_blank"
                       class="social"><i class="icon-twitter"></i> twitter</a></li>
                <li><a href="http://www.linkedin.com/profile/view?id=94597934"
                       title="Giulio De Donato Linkedin profile" target="_blank"
                       class="social">
                       <i class="icon-linkedin"></i> linkedin</a></li>
                <li><a href="http://www.slideshare.net/liuggio"
                       title="Giulio De Donato slideshare presentations" target="_blank"
                       class="social">
                       <img src="/assets/themes/readable-liuggio/img/slide.png" width="13"> slideshare
                       </a></li>
            </ul>
        </div>     
      </div>
      <p>© Giulio De Donato, 2013 — built with <a href="http://jekyllrb.com/">Jekyll.</a>
          <a href="http://welcometothebundle.com/feed.xml" title="feed" target="_blank">RSS feed</a>.
      </p>
    </footer>

<!-- /container -->
<script src="/assets/themes/readable-liuggio/bootstrap/js/jquery-1.8.3.min.js" type="text/javascript"></script>
<script src="/assets/themes/readable-liuggio/js/highlight.pack.js" type="text/javascript"></script>
<script src="/assets/themes/readable-liuggio/js/uitotop-jquery-plugin.js" type="text/javascript"></script>
<script src="/assets/themes/readable-liuggio/js/cloud.js" type="text/javascript"></script>


<script type="text/javascript">
    var links = document.links;
    for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if (links[i].hostname.replace("www.", "") != window.location.hostname.replace("www.", "") ) {
            links[i].target = '_blank';
        }
    }

    var links = document.links;
    for (var i = 0, linksLength = links.length; i < linksLength; i++) {

        if (links[i].href == 'http://www.slideshare.net/liuggio/rationally-boost-your-symfony2-application-with-caching-tips-and-monitoring') {

            //dirty solution in order to add slideshare frame into github Jekyll
            links[i].innerHTML = '<iframe src="http://www.slideshare.net/slideshow/embed_code/14625769?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/rationally-boost-your-symfony2-application-with-caching-tips-and-monitoring/?no" title="Rationally boost your symfony2 application with caching tips and monitoring" target="_blank">Rationally boost your symfony2 application with caching tips and monitoring</a></div>';
            break;
        } else if (links[i].href == 'http://www.slideshare.net/liuggio/its-all-about-behaviour-also-in-php') {
            links[i].innerHTML = '<iframe src="http://www.slideshare.net/slideshow/embed_code/27465974?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/its-all-about-behaviour-also-in-php/?no" title="It is all about behaviour also in php. PHP loves BDD." target="_blank">It is all about behaviour also in php. PHP loves BDD.</a></div>';
        } else if (links[i].href == 'http://www.slideshare.net/liuggio/design-pattern-symfony2') {
            links[i].innerHTML = '<div class="centered center"><iframe src="http://www.slideshare.net/slideshow/embed_code/27449969?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/design-pattern-symfony2/?no" title="Design pattern symfony2 - Nanos gigantium humeris insidentes" target="_blank">Design pattern Symfony2 - Nanos gigantium humeris insidentes</a></div></div>';
        } else if (links[i].href == 'http://www.slideshare.net/liuggio/caching-and-data-analysis-will-move-your-symfony2-application-to-the-next-level') {
            links[i].innerHTML = '<div class="centered center"><iframe src="http://www.slideshare.net/slideshow/embed_code/21395241?rel=0" width="512" height="421" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC;border-width:1px 1px 0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen> </iframe><div style="margin-bottom:5px"> <strong> <a href="http://www.slideshare.net/liuggio/caching-and-data-analysis-will-move-your-symfony2-application-to-the-next-level?no" title="Caching and data analysis will move your Symfony2 application to the next level" target="_blank">Caching and data analysis will move your Symfony2 application to the next level</a></div></div>';
        }
    }

</script>
<script type="text/javascript">
  var analytics=analytics||[];analytics.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+e+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);var r=function(e){return function(){analytics.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["identify","track","trackLink","trackForm","trackClick","trackSubmit","pageview","ab","alias","ready"];for(var s=0;s<i.length;s++)analytics[i[s]]=r(i[s])};
  analytics.load("wdoo4hzofo");
</script>

<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37195869-1']);
    _gaq.push(['_trackPageview']);

    (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();

</script>


<script>
    $(function () { // document ready
        if (!!$('.sticky').offset()) { // make sure ".sticky" element exists
            var stickyTop = $('.sticky').offset().top; // returns number
            $(window).scroll(function () { // scroll event
                $('#sticky-pagination').show().removeClass("hidden");
                var windowTop = $(window).scrollTop(); // returns number
                if (stickyTop < windowTop) {
                    $('.sticky').css({ position:'fixed', top:0, right:0 });
                    $('.sticky').addClass("well");
                    $('.sticky .inner').show();

                }
                else {
                    $('.sticky').css('position', 'static');
                    $('.sticky').removeClass("well").addClass("span1");
                    $('.sticky .inner').hide();
                    $('#sticky-pagination').hide();
                }
            });
        }
    });
</script>

 <script>
        //syntax highlight
        $(document).ready(function() {
            $('pre code').each(function(i, e) {hljs.highlightBlock(e)});
        });
    </script>
<script type="text/javascript">
    $.fn.tagcloud.defaults = {
      size: {start: 10, end: 20, unit: 'px'},
      color: {start: '#CD4540', end: '9C2520'}
    };

    $(function () {
      $('ul.tag_box li a').tagcloud();
    });
</script>

<script>
$(document).ready(function() {
    $('h2, h3, h4, h5').each(function(i, e) {
        var a = '<a class="headerlink" href="#'+e.id+'" name="#'+e.id+'" title="Permalink to this headline">¶</a>';
        $(e).append(a);
    });
});

$().UItoTop();

</script>


</body>
</html>

